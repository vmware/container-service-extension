#cloud-config
write_files:
- path: /root/kubeadm-defaults.conf
  owner: root
  content: |
    ---
    apiVersion: kubeadm.k8s.io/v1beta2
    kind: InitConfiguration
    bootstrapTokens:
    - groups:
      - system:bootstrappers:kubeadm:default-node-token
      ttl: 0s
      usages:
      - signing
      - authentication
    nodeRegistration:
      criSocket: /run/containerd/containerd.sock
      kubeletExtraArgs:
        cloud-provider: external
    ---
    apiVersion: kubeadm.k8s.io/v1beta2
    kind: ClusterConfiguration
    controlPlaneEndpoint: "{control_plane_endpoint}"
    dns:
      type: CoreDNS
      imageRepository: projects.registry.vmware.com/tkg
      imageTag: __COREDNS_VERSION_SED_ME__
    etcd:
      local:
        imageRepository: projects.registry.vmware.com/tkg
        imageTag: __ETCD_VERSION_SED_ME__
    networking:
      serviceSubnet: {service_cidr}
      podSubnet: {pod_cidr}
    imageRepository: projects.registry.vmware.com/tkg
    kubernetesVersion: __KUBERNETES_VERSION_SED_ME__
    ---
- path: /root/vcloud-basic-auth.yaml
  owner: root
  content: |
    ---
    apiVersion: v1
    data:
      password: ""
      username: ""
      refreshToken: {base64_encoded_refresh_token}
    kind: Secret
    metadata:
      name: vcloud-basic-auth
      namespace: kube-system
    ---
- path: /root/default-storage-class.yaml
  owner: root
  content: |
    ---
    kind: StorageClass
    apiVersion: storage.k8s.io/v1
    metadata:
      annotations:
        storageclass.kubernetes.io/is-default-class: "true"
      name: {default_storage_class_name}
    provisioner: named-disk.csi.cloud-director.vmware.com
    reclaimPolicy: {storage_class_reclaim_policy}
    parameters:
      storageProfile: {vcd_storage_profile_name}
      filesystem: {storage_class_filesystem_type}
    ---
- path: /root/kapp-controller.yaml
  owner: root
  content: |
    ---
    apiVersion: v1
    kind: Namespace
    metadata:
      name: tkg-system
    ---
    apiVersion: v1
    kind: Namespace
    metadata:
      name: tanzu-package-repo-global
    ---
    apiVersion: apiregistration.k8s.io/v1
    kind: APIService
    metadata:
      name: v1alpha1.data.packaging.carvel.dev
    spec:
      group: data.packaging.carvel.dev
      groupPriorityMinimum: 100
      service:
        name: packaging-api
        namespace: tkg-system
      version: v1alpha1
      versionPriority: 100
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: packaging-api
      namespace: tkg-system
    spec:
      ports:
      - port: 443
        protocol: TCP
        targetPort: api
      selector:
        app: kapp-controller
    ---
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      name: internalpackagemetadatas.internal.packaging.carvel.dev
    spec:
      group: internal.packaging.carvel.dev
      names:
        kind: InternalPackageMetadata
        listKind: InternalPackageMetadataList
        plural: internalpackagemetadatas
        singular: internalpackagemetadata
      scope: Namespaced
      versions:
      - name: v1alpha1
        schema:
          openAPIV3Schema:
            properties:
              apiVersion:
                description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
                type: string
              kind:
                description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                type: string
              metadata:
                type: object
              spec:
                properties:
                  categories:
                    items:
                      type: string
                    type: array
                  displayName:
                    type: string
                  iconSVGBase64:
                    type: string
                  longDescription:
                    type: string
                  maintainers:
                    items:
                      properties:
                        name:
                          type: string
                      type: object
                    type: array
                  providerName:
                    type: string
                  shortDescription:
                    type: string
                  supportDescription:
                    type: string
                type: object
            required:
            - spec
            type: object
        served: true
        storage: true
        subresources:
          status: OPEN_BRACKETCLOSE_BRACKET
    ---
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      name: internalpackages.internal.packaging.carvel.dev
    spec:
      group: internal.packaging.carvel.dev
      names:
        kind: InternalPackage
        listKind: InternalPackageList
        plural: internalpackages
        singular: internalpackage
      scope: Namespaced
      versions:
      - name: v1alpha1
        schema:
          openAPIV3Schema:
            properties:
              apiVersion:
                description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
                type: string
              kind:
                description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                type: string
              metadata:
                type: object
              spec:
                properties:
                  capacityRequirementsDescription:
                    type: string
                  licenses:
                    items:
                      type: string
                    type: array
                  refName:
                    type: string
                  releaseNotes:
                    type: string
                  releasedAt:
                    format: date-time
                    nullable: true
                    type: string
                  template:
                    properties:
                      spec:
                        properties:
                          canceled:
                            description: Canceled when set to true will stop all active changes
                            type: boolean
                          cluster:
                            properties:
                              kubeconfigSecretRef:
                                properties:
                                  key:
                                    type: string
                                  name:
                                    type: string
                                type: object
                              namespace:
                                type: string
                            type: object
                          deploy:
                            items:
                              properties:
                                kapp:
                                  properties:
                                    delete:
                                      properties:
                                        rawOptions:
                                          items:
                                            type: string
                                          type: array
                                      type: object
                                    inspect:
                                      properties:
                                        rawOptions:
                                          items:
                                            type: string
                                          type: array
                                      type: object
                                    intoNs:
                                      type: string
                                    mapNs:
                                      items:
                                        type: string
                                      type: array
                                    rawOptions:
                                      items:
                                        type: string
                                      type: array
                                  type: object
                              type: object
                            type: array
                          fetch:
                            items:
                              properties:
                                git:
                                  description: TODO implement git
                                  properties:
                                    lfsSkipSmudge:
                                      type: boolean
                                    ref:
                                      type: string
                                    secretRef:
                                      description: 'Secret may include one or more keys: ssh-privatekey, ssh-knownhosts'
                                      properties:
                                        name:
                                          description: Object is expected to be within same namespace
                                          type: string
                                      type: object
                                    subPath:
                                      type: string
                                    url:
                                      type: string
                                  type: object
                                helmChart:
                                  properties:
                                    name:
                                      description: 'Example: stable/redis'
                                      type: string
                                    repository:
                                      properties:
                                        secretRef:
                                          properties:
                                            name:
                                              description: Object is expected to be within same namespace
                                              type: string
                                          type: object
                                        url:
                                          type: string
                                      type: object
                                    version:
                                      type: string
                                  type: object
                                http:
                                  properties:
                                    secretRef:
                                      description: 'Secret may include one or more keys: username, password'
                                      properties:
                                        name:
                                          description: Object is expected to be within same namespace
                                          type: string
                                      type: object
                                    sha256:
                                      type: string
                                    subPath:
                                      type: string
                                    url:
                                      description: 'URL can point to one of following formats: text, tgz, zip'
                                      type: string
                                  type: object
                                image:
                                  properties:
                                    secretRef:
                                      description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                                      properties:
                                        name:
                                          description: Object is expected to be within same namespace
                                          type: string
                                      type: object
                                    subPath:
                                      type: string
                                    url:
                                      description: 'Example: username/app1-config:v0.1.0'
                                      type: string
                                  type: object
                                imgpkgBundle:
                                  properties:
                                    image:
                                      type: string
                                    secretRef:
                                      description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                                      properties:
                                        name:
                                          description: Object is expected to be within same namespace
                                          type: string
                                      type: object
                                  type: object
                                inline:
                                  properties:
                                    paths:
                                      additionalProperties:
                                        type: string
                                      type: object
                                    pathsFrom:
                                      items:
                                        properties:
                                          configMapRef:
                                            properties:
                                              directoryPath:
                                                type: string
                                              name:
                                                type: string
                                            type: object
                                          secretRef:
                                            properties:
                                              directoryPath:
                                                type: string
                                              name:
                                                type: string
                                            type: object
                                        type: object
                                      type: array
                                  type: object
                              type: object
                            type: array
                          noopDelete:
                            description: When NoopDeletion set to true, App deletion should delete App CR but preserve App's associated resources
                            type: boolean
                          paused:
                            description: Paused when set to true will ignore all pending changes, once it set back to false, pending changes will be applied
                            type: boolean
                          serviceAccountName:
                            type: string
                          syncPeriod:
                            description: Controls frequency of app reconciliation
                            type: string
                          template:
                            items:
                              properties:
                                helmTemplate:
                                  properties:
                                    name:
                                      type: string
                                    namespace:
                                      type: string
                                    path:
                                      type: string
                                    valuesFrom:
                                      items:
                                        properties:
                                          configMapRef:
                                            properties:
                                              name:
                                                type: string
                                            type: object
                                          path:
                                            type: string
                                          secretRef:
                                            properties:
                                              name:
                                                type: string
                                            type: object
                                        type: object
                                      type: array
                                  type: object
                                jsonnet:
                                  description: TODO implement jsonnet
                                  type: object
                                kbld:
                                  properties:
                                    paths:
                                      items:
                                        type: string
                                      type: array
                                  type: object
                                kustomize:
                                  description: TODO implement kustomize
                                  type: object
                                sops:
                                  properties:
                                    paths:
                                      items:
                                        type: string
                                      type: array
                                    pgp:
                                      properties:
                                        privateKeysSecretRef:
                                          properties:
                                            name:
                                              type: string
                                          type: object
                                      type: object
                                  type: object
                                ytt:
                                  properties:
                                    fileMarks:
                                      items:
                                        type: string
                                      type: array
                                    ignoreUnknownComments:
                                      type: boolean
                                    inline:
                                      properties:
                                        paths:
                                          additionalProperties:
                                            type: string
                                          type: object
                                        pathsFrom:
                                          items:
                                            properties:
                                              configMapRef:
                                                properties:
                                                  directoryPath:
                                                    type: string
                                                  name:
                                                    type: string
                                                type: object
                                              secretRef:
                                                properties:
                                                  directoryPath:
                                                    type: string
                                                  name:
                                                    type: string
                                                type: object
                                            type: object
                                          type: array
                                      type: object
                                    paths:
                                      items:
                                        type: string
                                      type: array
                                    strict:
                                      type: boolean
                                    valuesFrom:
                                      items:
                                        properties:
                                          configMapRef:
                                            properties:
                                              name:
                                                type: string
                                            type: object
                                          path:
                                            type: string
                                          secretRef:
                                            properties:
                                              name:
                                                type: string
                                            type: object
                                        type: object
                                      type: array
                                  type: object
                              type: object
                            type: array
                        type: object
                    required:
                    - spec
                    type: object
                  valuesSchema:
                    description: valuesSchema can be used to show template values that can be configured by users when a Package is installed in an OpenAPI schema format.
                    properties:
                      openAPIv3:
                        nullable: true
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                    type: object
                  version:
                    type: string
                type: object
            required:
            - spec
            type: object
        served: true
        storage: true
        subresources:
          status: OPEN_BRACKETCLOSE_BRACKET
    ---
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      name: apps.kappctrl.k14s.io
    spec:
      group: kappctrl.k14s.io
      names:
        kind: App
        listKind: AppList
        plural: apps
        singular: app
      scope: Namespaced
      versions:
      - additionalPrinterColumns:
        - description: Friendly description
          jsonPath: .status.friendlyDescription
          name: Description
          type: string
        - description: Last time app started being deployed. Does not mean anything was changed.
          jsonPath: .status.deploy.startedAt
          name: Since-Deploy
          type: date
        - description: Time since creation
          jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
        name: v1alpha1
        schema:
          openAPIV3Schema:
            properties:
              apiVersion:
                description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
                type: string
              kind:
                description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                type: string
              metadata:
                type: object
              spec:
                properties:
                  canceled:
                    description: Canceled when set to true will stop all active changes
                    type: boolean
                  cluster:
                    properties:
                      kubeconfigSecretRef:
                        properties:
                          key:
                            type: string
                          name:
                            type: string
                        type: object
                      namespace:
                        type: string
                    type: object
                  deploy:
                    items:
                      properties:
                        kapp:
                          properties:
                            delete:
                              properties:
                                rawOptions:
                                  items:
                                    type: string
                                  type: array
                              type: object
                            inspect:
                              properties:
                                rawOptions:
                                  items:
                                    type: string
                                  type: array
                              type: object
                            intoNs:
                              type: string
                            mapNs:
                              items:
                                type: string
                              type: array
                            rawOptions:
                              items:
                                type: string
                              type: array
                          type: object
                      type: object
                    type: array
                  fetch:
                    items:
                      properties:
                        git:
                          description: TODO implement git
                          properties:
                            lfsSkipSmudge:
                              type: boolean
                            ref:
                              type: string
                            secretRef:
                              description: 'Secret may include one or more keys: ssh-privatekey, ssh-knownhosts'
                              properties:
                                name:
                                  description: Object is expected to be within same namespace
                                  type: string
                              type: object
                            subPath:
                              type: string
                            url:
                              type: string
                          type: object
                        helmChart:
                          properties:
                            name:
                              description: 'Example: stable/redis'
                              type: string
                            repository:
                              properties:
                                secretRef:
                                  properties:
                                    name:
                                      description: Object is expected to be within same namespace
                                      type: string
                                  type: object
                                url:
                                  type: string
                              type: object
                            version:
                              type: string
                          type: object
                        http:
                          properties:
                            secretRef:
                              description: 'Secret may include one or more keys: username, password'
                              properties:
                                name:
                                  description: Object is expected to be within same namespace
                                  type: string
                              type: object
                            sha256:
                              type: string
                            subPath:
                              type: string
                            url:
                              description: 'URL can point to one of following formats: text, tgz, zip'
                              type: string
                          type: object
                        image:
                          properties:
                            secretRef:
                              description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                              properties:
                                name:
                                  description: Object is expected to be within same namespace
                                  type: string
                              type: object
                            subPath:
                              type: string
                            url:
                              description: 'Example: username/app1-config:v0.1.0'
                              type: string
                          type: object
                        imgpkgBundle:
                          properties:
                            image:
                              type: string
                            secretRef:
                              description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                              properties:
                                name:
                                  description: Object is expected to be within same namespace
                                  type: string
                              type: object
                          type: object
                        inline:
                          properties:
                            paths:
                              additionalProperties:
                                type: string
                              type: object
                            pathsFrom:
                              items:
                                properties:
                                  configMapRef:
                                    properties:
                                      directoryPath:
                                        type: string
                                      name:
                                        type: string
                                    type: object
                                  secretRef:
                                    properties:
                                      directoryPath:
                                        type: string
                                      name:
                                        type: string
                                    type: object
                                type: object
                              type: array
                          type: object
                      type: object
                    type: array
                  noopDelete:
                    description: When NoopDeletion set to true, App deletion should delete App CR but preserve App's associated resources
                    type: boolean
                  paused:
                    description: Paused when set to true will ignore all pending changes, once it set back to false, pending changes will be applied
                    type: boolean
                  serviceAccountName:
                    type: string
                  syncPeriod:
                    description: Controls frequency of app reconciliation
                    type: string
                  template:
                    items:
                      properties:
                        helmTemplate:
                          properties:
                            name:
                              type: string
                            namespace:
                              type: string
                            path:
                              type: string
                            valuesFrom:
                              items:
                                properties:
                                  configMapRef:
                                    properties:
                                      name:
                                        type: string
                                    type: object
                                  path:
                                    type: string
                                  secretRef:
                                    properties:
                                      name:
                                        type: string
                                    type: object
                                type: object
                              type: array
                          type: object
                        jsonnet:
                          description: TODO implement jsonnet
                          type: object
                        kbld:
                          properties:
                            paths:
                              items:
                                type: string
                              type: array
                          type: object
                        kustomize:
                          description: TODO implement kustomize
                          type: object
                        sops:
                          properties:
                            paths:
                              items:
                                type: string
                              type: array
                            pgp:
                              properties:
                                privateKeysSecretRef:
                                  properties:
                                    name:
                                      type: string
                                  type: object
                              type: object
                          type: object
                        ytt:
                          properties:
                            fileMarks:
                              items:
                                type: string
                              type: array
                            ignoreUnknownComments:
                              type: boolean
                            inline:
                              properties:
                                paths:
                                  additionalProperties:
                                    type: string
                                  type: object
                                pathsFrom:
                                  items:
                                    properties:
                                      configMapRef:
                                        properties:
                                          directoryPath:
                                            type: string
                                          name:
                                            type: string
                                        type: object
                                      secretRef:
                                        properties:
                                          directoryPath:
                                            type: string
                                          name:
                                            type: string
                                        type: object
                                    type: object
                                  type: array
                              type: object
                            paths:
                              items:
                                type: string
                              type: array
                            strict:
                              type: boolean
                            valuesFrom:
                              items:
                                properties:
                                  configMapRef:
                                    properties:
                                      name:
                                        type: string
                                    type: object
                                  path:
                                    type: string
                                  secretRef:
                                    properties:
                                      name:
                                        type: string
                                    type: object
                                type: object
                              type: array
                          type: object
                      type: object
                    type: array
                type: object
              status:
                properties:
                  conditions:
                    items:
                      description: TODO rename to Condition
                      properties:
                        message:
                          description: Human-readable message indicating details about last transition.
                          type: string
                        reason:
                          description: Unique, this should be a short, machine understandable string that gives the reason for condition's last transition. If it reports "ResizeStarted" that means the underlying persistent volume is being resized.
                          type: string
                        status:
                          type: string
                        type:
                          type: string
                      required:
                      - status
                      - type
                      type: object
                    type: array
                  consecutiveReconcileFailures:
                    type: integer
                  consecutiveReconcileSuccesses:
                    type: integer
                  deploy:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      finished:
                        type: boolean
                      startedAt:
                        format: date-time
                        type: string
                      stderr:
                        type: string
                      stdout:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  fetch:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      startedAt:
                        format: date-time
                        type: string
                      stderr:
                        type: string
                      stdout:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  friendlyDescription:
                    type: string
                  inspect:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      stderr:
                        type: string
                      stdout:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  managedAppName:
                    type: string
                  observedGeneration:
                    format: int64
                    type: integer
                  template:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      stderr:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  usefulErrorMessage:
                    type: string
                type: object
            required:
            - spec
            type: object
        served: true
        storage: true
        subresources:
          status: OPEN_BRACKETCLOSE_BRACKET
    ---
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      name: packageinstalls.packaging.carvel.dev
    spec:
      group: packaging.carvel.dev
      names:
        kind: PackageInstall
        listKind: PackageInstallList
        plural: packageinstalls
        shortNames:
        - pkgi
        singular: packageinstall
      scope: Namespaced
      versions:
      - additionalPrinterColumns:
        - description: PackageMetadata name
          jsonPath: .spec.packageRef.refName
          name: Package name
          type: string
        - description: PackageMetadata version
          jsonPath: .status.version
          name: Package version
          type: string
        - description: Friendly description
          jsonPath: .status.friendlyDescription
          name: Description
          type: string
        - description: Time since creation
          jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
        name: v1alpha1
        schema:
          openAPIV3Schema:
            properties:
              apiVersion:
                description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
                type: string
              kind:
                description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                type: string
              metadata:
                type: object
              spec:
                properties:
                  canceled:
                    description: Canceled when set to true will stop all active changes
                    type: boolean
                  cluster:
                    properties:
                      kubeconfigSecretRef:
                        properties:
                          key:
                            type: string
                          name:
                            type: string
                        type: object
                      namespace:
                        type: string
                    type: object
                  noopDelete:
                    description: When NoopDelete set to true, PackageInstall deletion should delete PackageInstall/App CR but preserve App's associated resources.
                    type: boolean
                  packageRef:
                    properties:
                      refName:
                        type: string
                      versionSelection:
                        properties:
                          constraints:
                            type: string
                          prereleases:
                            properties:
                              identifiers:
                                items:
                                  type: string
                                type: array
                            type: object
                        type: object
                    type: object
                  paused:
                    description: Paused when set to true will ignore all pending changes, once it set back to false, pending changes will be applied
                    type: boolean
                  serviceAccountName:
                    type: string
                  syncPeriod:
                    description: Controls frequency of App reconciliation in time + unit format. Always >= 30s. If value below 30s is specified, 30s will be used.
                    type: string
                  values:
                    items:
                      properties:
                        secretRef:
                          properties:
                            key:
                              type: string
                            name:
                              type: string
                          type: object
                      type: object
                    type: array
                type: object
              status:
                properties:
                  conditions:
                    items:
                      description: TODO rename to Condition
                      properties:
                        message:
                          description: Human-readable message indicating details about last transition.
                          type: string
                        reason:
                          description: Unique, this should be a short, machine understandable string that gives the reason for condition's last transition. If it reports "ResizeStarted" that means the underlying persistent volume is being resized.
                          type: string
                        status:
                          type: string
                        type:
                          type: string
                      required:
                      - status
                      - type
                      type: object
                    type: array
                  friendlyDescription:
                    type: string
                  observedGeneration:
                    format: int64
                    type: integer
                  usefulErrorMessage:
                    type: string
                  version:
                    description: TODO this is desired resolved version (not actually deployed)
                    type: string
                type: object
            required:
            - spec
            type: object
        served: true
        storage: true
        subresources:
          status: OPEN_BRACKETCLOSE_BRACKET
    ---
    apiVersion: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    metadata:
      annotations:
        packaging.carvel.dev/global-namespace: tanzu-package-repo-global
      name: packagerepositories.packaging.carvel.dev
    spec:
      group: packaging.carvel.dev
      names:
        kind: PackageRepository
        listKind: PackageRepositoryList
        plural: packagerepositories
        shortNames:
        - pkgr
        singular: packagerepository
      scope: Namespaced
      versions:
      - additionalPrinterColumns:
        - description: Time since creation
          jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
        - description: Friendly description
          jsonPath: .status.friendlyDescription
          name: Description
          type: string
        name: v1alpha1
        schema:
          openAPIV3Schema:
            properties:
              apiVersion:
                description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
                type: string
              kind:
                description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
                type: string
              metadata:
                type: object
              spec:
                properties:
                  fetch:
                    properties:
                      git:
                        description: TODO implement git
                        properties:
                          lfsSkipSmudge:
                            type: boolean
                          ref:
                            type: string
                          secretRef:
                            description: 'Secret may include one or more keys: ssh-privatekey, ssh-knownhosts'
                            properties:
                              name:
                                description: Object is expected to be within same namespace
                                type: string
                            type: object
                          subPath:
                            type: string
                          url:
                            type: string
                        type: object
                      http:
                        properties:
                          secretRef:
                            description: 'Secret may include one or more keys: username, password'
                            properties:
                              name:
                                description: Object is expected to be within same namespace
                                type: string
                            type: object
                          sha256:
                            type: string
                          subPath:
                            type: string
                          url:
                            description: 'URL can point to one of following formats: text, tgz, zip'
                            type: string
                        type: object
                      image:
                        properties:
                          secretRef:
                            description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                            properties:
                              name:
                                description: Object is expected to be within same namespace
                                type: string
                            type: object
                          subPath:
                            type: string
                          url:
                            description: 'Example: username/app1-config:v0.1.0'
                            type: string
                        type: object
                      imgpkgBundle:
                        properties:
                          image:
                            type: string
                          secretRef:
                            description: 'Secret may include one or more keys: username, password, token. By default anonymous access is used for authentication. TODO support docker config formated secret'
                            properties:
                              name:
                                description: Object is expected to be within same namespace
                                type: string
                            type: object
                        type: object
                    type: object
                  paused:
                    description: Paused when set to true will ignore all pending changes, once it set back to false, pending changes will be applied
                    type: boolean
                  syncPeriod:
                    description: Controls frequency of PackageRepository reconciliation
                    type: string
                required:
                - fetch
                type: object
              status:
                properties:
                  conditions:
                    items:
                      description: TODO rename to Condition
                      properties:
                        message:
                          description: Human-readable message indicating details about last transition.
                          type: string
                        reason:
                          description: Unique, this should be a short, machine understandable string that gives the reason for condition's last transition. If it reports "ResizeStarted" that means the underlying persistent volume is being resized.
                          type: string
                        status:
                          type: string
                        type:
                          type: string
                      required:
                      - status
                      - type
                      type: object
                    type: array
                  consecutiveReconcileFailures:
                    type: integer
                  consecutiveReconcileSuccesses:
                    type: integer
                  deploy:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      finished:
                        type: boolean
                      startedAt:
                        format: date-time
                        type: string
                      stderr:
                        type: string
                      stdout:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  fetch:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      startedAt:
                        format: date-time
                        type: string
                      stderr:
                        type: string
                      stdout:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  friendlyDescription:
                    type: string
                  observedGeneration:
                    format: int64
                    type: integer
                  template:
                    properties:
                      error:
                        type: string
                      exitCode:
                        type: integer
                      stderr:
                        type: string
                      updatedAt:
                        format: date-time
                        type: string
                    type: object
                  usefulErrorMessage:
                    type: string
                type: object
            required:
            - spec
            type: object
        served: true
        storage: true
        subresources:
          status: OPEN_BRACKETCLOSE_BRACKET
    ---
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: kapp-controller-config
      namespace: tkg-system
      annotations:
        kapp.k14s.io/change-group: apps.kappctrl.k14s.io/kapp-controller-config
    data:
      caCerts: ""
      httpProxy: ""
      httpsProxy: ""
      noProxy: ""
      dangerousSkipTLSVerify: ""
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      annotations:
        kapp-controller.carvel.dev/version: v__KAPP_CONTROLLER_VERSION_SED_ME__
        kapp.k14s.io/change-rule: upsert after upserting apps.kappctrl.k14s.io/kapp-controller-config
      name: kapp-controller
      namespace: tkg-system
    spec:
      replicas: 1
      revisionHistoryLimit: 0
      selector:
        matchLabels:
          app: kapp-controller
      template:
        metadata:
          labels:
            app: kapp-controller
        spec:
          containers:
          - args:
            - -packaging-global-namespace=tanzu-package-repo-global
            - -concurrency=4
            env:
            - name: KAPPCTRL_MEM_TMP_DIR
              value: /etc/kappctrl-mem-tmp
            - name: KAPPCTRL_SYSTEM_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: KAPPCTRL_API_PORT
              value: "10350"
            image: projects.registry.VMware.com/tkg/kapp-controller:v__FULL_KAPP_CONTROLLER_VERSION_SED_ME__
            name: kapp-controller
            ports:
            - containerPort: 10350
              name: api
              protocol: TCP
            resources:
              requests:
                cpu: 120m
                memory: 100Mi
            securityContext:
              runAsGroup: 2000
              runAsUser: 1000
            volumeMounts:
            - mountPath: /etc/kappctrl-mem-tmp
              name: template-fs
          securityContext:
            fsGroup: 3000
          serviceAccount: kapp-controller-sa
          volumes:
          - emptyDir:
              medium: Memory
            name: template-fs
          priorityClassName: system-cluster-critical
          tolerations:
          - key: CriticalAddonsOnly
            operator: Exists
          - effect: NoSchedule
            key: node-role.kubernetes.io/master
          - effect: NoSchedule
            key: node.kubernetes.io/not-ready
          - effect: NoSchedule
            key: node.cloudprovider.kubernetes.io/uninitialized
            value: "true"
    ---
    apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: kapp-controller-sa
      namespace: tkg-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: kapp-controller-cluster-role
    rules:
    - apiGroups:
      - ""
      resources:
      - secrets
      - configmaps
      verbs:
      - get
      - list
      - watch
      - create
    - apiGroups:
      - ""
      resources:
      - serviceaccounts
      verbs:
      - get
    - apiGroups:
      - kappctrl.k14s.io
      resources:
      - apps
      - apps/status
      verbs:
      - '*'
    - apiGroups:
      - packaging.carvel.dev
      resources:
      - packageinstalls
      - packageinstalls/status
      verbs:
      - '*'
    - apiGroups:
      - packaging.carvel.dev
      resources:
      - packagerepositories
      - packagerepositories/status
      verbs:
      - '*'
    - apiGroups:
      - internal.packaging.carvel.dev
      resources:
      - internalpackagemetadatas
      verbs:
      - '*'
    - apiGroups:
      - data.packaging.carvel.dev
      resources:
      - packagemetadatas
      - packagemetadatas/status
      verbs:
      - '*'
    - apiGroups:
      - internal.packaging.carvel.dev
      resources:
      - internalpackages
      verbs:
      - '*'
    - apiGroups:
      - data.packaging.carvel.dev
      resources:
      - packages
      - packages/status
      verbs:
      - '*'
    - apiGroups:
      - ""
      resources:
      - configmaps
      verbs:
      - '*'
    - apiGroups:
      - apiregistration.k8s.io
      resources:
      - apiservices
      verbs:
      - update
      - get
    - apiGroups:
      - ""
      resources:
      - namespaces
      verbs:
      - list
      - watch
      - get
      - update
    - apiGroups:
      - admissionregistration.k8s.io
      resources:
      - mutatingwebhookconfigurations
      verbs:
      - list
      - watch
    - apiGroups:
      - admissionregistration.k8s.io
      resources:
      - validatingwebhookconfigurations
      verbs:
      - list
      - watch
    - apiGroups:
      - policy
      resources:
      - podsecuritypolicies
      resourceNames:
      - tanzu-system-kapp-ctrl-restricted
      verbs:
      - use
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: kapp-controller-cluster-role-binding
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: kapp-controller-cluster-role
    subjects:
    - kind: ServiceAccount
      name: kapp-controller-sa
      namespace: tkg-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: pkg-apiserver:system:auth-delegator
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: system:auth-delegator
    subjects:
    - kind: ServiceAccount
      name: kapp-controller-sa
      namespace: tkg-system
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      name: pkgserver-auth-reader
      namespace: kube-system
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: extension-apiserver-authentication-reader
    subjects:
    - kind: ServiceAccount
      name: kapp-controller-sa
      namespace: tkg-system
    ---
- path: /root/control_plane.sh
  owner: root
  content: |
    #!/usr/bin/env bash

    catch() {{
      retval=$?
       error_message="$(date) $(caller): $BASH_COMMAND"
       echo "$error_message" &>> /var/log/cse/customization/error.log
       vmtoolsd --cmd "info-set guestinfo.post_customization_script_execution_failure_reason $error_message"
       vmtoolsd --cmd "info-set guestinfo.post_customization_script_execution_status $retval"
    }}

    mkdir -p /var/log/cse/customization

    trap 'catch $? $LINENO' ERR

    set -ex

    echo "$(date) Post Customization script execution in progress" &>> /var/log/cse/customization/status.log

    kubeadm_config_path=/root/kubeadm-defaults.conf

    vcloud_basic_auth_path=/root/vcloud-basic-auth.yaml
    vcloud_configmap_path=/root/vcloud-configmap.yaml
    vcloud_ccm_path=/root/cloud-director-ccm.yaml

    vcloud_csi_configmap_path=/root/vcloud-csi-configmap.yaml
    csi_driver_path=/root/csi-driver.yaml
    csi_controller_path=/root/csi-controller.yaml
    csi_node_path=/root/csi-node.yaml
    kapp_controller_path=/root/kapp_controller.yaml

    vmtoolsd --cmd "info-set guestinfo.postcustomization.networkconfiguration.status in_progress"
      echo 'net.ipv6.conf.all.disable_ipv6 = 1' >> /etc/sysctl.conf
      echo 'net.ipv6.conf.default.disable_ipv6 = 1' >> /etc/sysctl.conf
      echo 'net.ipv6.conf.lo.disable_ipv6 = 1' >> /etc/sysctl.conf
      sudo sysctl -p

      # also remove ipv6 localhost entry from /etc/hosts
      sed -i 's/::1/127.0.0.1/g' /etc/hosts || true
    vmtoolsd --cmd "info-set guestinfo.postcustomization.networkconfiguration.status successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.store.sshkey.status in_progress"
      ssh_key="{ssh_key}"
      if [[ ! -z "$ssh_key" ]];
      then
        mkdir -p /root/.ssh
        echo $ssh_key >> /root/.ssh/authorized_keys
        chmod -R go-rwx /root/.ssh
      fi
    vmtoolsd --cmd "info-set guestinfo.postcustomization.store.sshkey.status successful"

    vmtoolsd --cmd "info-set guestinfo.postcustomization.proxy.setting.status in_progress"
    export HTTP_PROXY="{http_proxy}"
    export HTTPS_PROXY="{https_proxy}"
    export http_proxy="{http_proxy}"
    export https_proxy="{https_proxy}"
    export NO_PROXY="{no_proxy}"
    export no_proxy="{no_proxy}"

    mkdir -p /etc/systemd/system/containerd.service.d
    cat <<END > /etc/systemd/system/containerd.service.d/http-proxy.conf
    [Service]
    Environment="HTTP_PROXY={http_proxy}"
    Environment="HTTPS_PROXY={https_proxy}"
    Environment="http_proxy={http_proxy}"
    Environment="https_proxy={https_proxy}"
    Environment="no_proxy={no_proxy}"
    Environment="NO_PROXY={no_proxy}"
    END
    systemctl daemon-reload
    systemctl restart containerd
    vmtoolsd --cmd "info-set guestinfo.postcustomization.proxy.setting.status successful"

    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubeinit.status in_progress"
      # tag images
      coredns_image_version=""
      etcd_image_version=""
      kubernetes_version=""
      for image in "coredns" "etcd" "kube-proxy" "kube-apiserver" "kube-controller-manager" "kube-scheduler"
      do
        image_ref=$(ctr -n=k8s.io image list | cut -d" " -f1 | grep $image)
        ref_path=$(echo $image_ref | sed 's/:.*//')
        new_tag_version=$(echo $image_ref | sed 's/.*://' | sed 's/_/-/')
        ctr -n=k8s.io image tag $image_ref $ref_path:$new_tag_version

        # save image tags for later
        if [[ "$image" = "coredns" ]]; then
          sed -i "s/__COREDNS_VERSION_SED_ME__/$new_tag_version/g" $kubeadm_config_path
        elif [[ "$image" = "etcd" ]]; then
          sed -i "s/__ETCD_VERSION_SED_ME__/$new_tag_version/g" $kubeadm_config_path
        elif [[ "$image" = "kube-proxy" ]]; then # selecting other kube-* images would work too
          sed -i "s/__KUBERNETES_VERSION_SED_ME__/$new_tag_version/g" $kubeadm_config_path
        fi
      done

      kubeadm init --config $kubeadm_config_path --v=10 &> /root/kubeadm-init.out
      export KUBECONFIG=/etc/kubernetes/admin.conf
    vmtoolsd --cmd "info-set guestinfo.kubeconfig $(cat /etc/kubernetes/admin.conf | base64 | tr -d '\n')"
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubeinit.status successful"

    # open_bracket(all caps) will be replaced by the open bracket and close_bracket (all caps)
    # will be replaced by an open bracket.
    # This convention is needed so that python's template format function does not view the bash
    # $\open_bracket/VAR/\close_bracket as a format variable that will be replaced by the python format function.
    antrea_version="{antrea_version}"
    kapp_controller_version=""
    metrics_server_version=""
    metrics_server_version_valid=true
    vmtoolsd --cmd "info-set guestinfo.postcustomization.tkr.get_versions.status in_progress"
      if [[ -z "$antrea_version" ]]; then
      tkr_bom_dir=/tmp/tkr_bom
      bom_path=$tkr_bom_dir/bom
      mkdir -p $bom_path
      components_path=$bom_path/components.yaml
      imgpkg_path=$tkr_bom_dir/imgpkg
      yq_path=$tkr_bom_dir/yq
      default_antrea_version="0.11.3"

      xml_version_property=$(vmtoolsd --cmd "info-get guestinfo.ovfenv" | grep "oe:key=\"VERSION\"")
      init_k8s_version=$(echo $xml_version_property | sed 's/.*oe:value=\"//; s/\(.*\)-.*/\1/')
      k8s_version=$(echo $init_k8s_version | tr -s "+" "_")

      # install imgpkg, which is needed for getting the components yaml file
      wget -nv github.com/vmware-tanzu/carvel-imgpkg/releases/download/v0.24.0/imgpkg-linux-amd64 -O $imgpkg_path
      chmod +x $imgpkg_path

      # We need to loop through the `X` value in `tkg.X` because of some TKR unexpected design.
      # We increment `X`, looking fir a valid tkr bom version.
      no_tkr_found=false
      until $imgpkg_path pull -i projects.registry.vmware.com/tkg/tkr-bom:$OPEN_BRACKETk8s_versionCLOSE_BRACKET -o $bom_path
      do
        tkg_version=$(echo $OPEN_BRACKETk8s_version//*.CLOSE_BRACKET)
        tkg_version=$((tkg_version+1))
        k8s_version=$(echo $k8s_version | sed "s/.$/"$tkg_version"/")
        if [[ $tkg_version -gt 10 ]]; then
          no_tkr_found=true
          break
        fi
      done

      mv $bom_path/*.yaml $components_path
      # install yq for yaml parsing
      wget https://github.com/mikefarah/yq/releases/download/v4.2.0/yq_linux_amd64 -O $yq_path
      chmod +x $yq_path

      # handle getting antrea version
      if [[ -z "$antrea_version" ]]; then
        if [[ "$no_tkr_found" = true ]] ; then
          echo "no tkr bom found, will use default component versions"  &>> /var/log/cse/customization/status.log
          antrea_version=$default_antrea_version
        else
          # will get antrea version from tkr file
          antrea_version=$($yq_path e ".components.antrea[0].version" $components_path | sed 's/+.*//')
          if [[ -z "$antrea_version" ]] || [[ "$antrea_version" = "null" ]] || [[ "$antrea_version" = "false" ]]; then
            antrea_version=$default_antrea_version
          else
            antrea_version=$(echo $antrea_version | sed "s/v//") # remove leading `v`, which will be added later
          fi
        fi
      fi

      # get kapp-controller version
      full_kapp_controller_version=$($yq_path e ".components.kapp-controller[0].images.kappControllerImage.tag" $components_path | sed 's/v//')
      kapp_controller_version=$(echo $full_kapp_controller_version | sed 's/_.*//')
      metrics_server_version=$($yq_path e ".components.metrics-server[0].version" $components_path | sed 's/v//')
      if [[ -z "$metrics_server_version_ready" ]] || [[ "$metrics_server_version_ready" = "null" ]] || [[ "$metrics_server_version_ready" = "false" ]]; then
        metrics_server_version_ready=false
      fi
      # cleanup components downloads
      rm -rf $tkr_bom_dir
      fi
    vmtoolsd --cmd "info-set guestinfo.postcustomization.tkr.get_versions.status successful"

    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.cni.install.status in_progress"
      antrea_path=/root/antrea-$OPEN_BRACKETantrea_versionCLOSE_BRACKET.yaml
      wget -O $antrea_path https://github.com/vmware-tanzu/antrea/releases/download/v$OPEN_BRACKETantrea_versionCLOSE_BRACKET/antrea.yml
      # This does not need to be done from v0.12.0 onwards inclusive
      sed -i "s/image: antrea\/antrea-ubuntu:v$OPEN_BRACKETantrea_versionCLOSE_BRACKET/image: projects.registry.vmware.com\/antrea\/antrea-ubuntu:v$OPEN_BRACKETantrea_versionCLOSE_BRACKET/g" $antrea_path
      kubectl apply -f $antrea_path
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.cni.install.status successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.cpi.install.status in_progress"
      kubectl apply -f $vcloud_basic_auth_path

      wget -O $vcloud_configmap_path https://raw.githubusercontent.com/vmware/cloud-provider-for-cloud-director/{cpi_version}/manifests/vcloud-configmap.yaml
      sed -i 's/VCD_HOST/"{vcd_host}"/' $vcloud_configmap_path
      sed -i 's/ORG/"{org}"/' $vcloud_configmap_path
      sed -i 's/OVDC/"{vdc}"/' $vcloud_configmap_path
      sed -i 's/NETWORK/"{network_name}"/' $vcloud_configmap_path
      sed -i 's/VIP_SUBNET_CIDR/"{vip_subnet_cidr}"/' $vcloud_configmap_path
      sed -i 's/VAPP/{cluster_name}/' $vcloud_configmap_path
      sed -i 's/CLUSTER_ID/{cluster_id}/' $vcloud_configmap_path
      kubectl apply -f $vcloud_configmap_path

      wget -O $vcloud_ccm_path https://raw.githubusercontent.com/vmware/cloud-provider-for-cloud-director/{cpi_version}/manifests/cloud-director-ccm.yaml
      kubectl apply -f $vcloud_ccm_path
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.cpi.install.status successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.csi.install.status in_progress"
      wget -O $vcloud_csi_configmap_path https://raw.githubusercontent.com/vmware/cloud-director-named-disk-csi-driver/{csi_version}/manifests/vcloud-csi-config.yaml
      sed -i 's/VCD_HOST/"{vcd_host}"/' $vcloud_csi_configmap_path
      sed -i 's/ORG/"{org}"/' $vcloud_csi_configmap_path
      sed -i 's/OVDC/"{vdc}"/' $vcloud_csi_configmap_path
      sed -i 's/VAPP/{cluster_name}/' $vcloud_csi_configmap_path
      sed -i 's/CLUSTER_ID/"{cluster_id}"/' $vcloud_csi_configmap_path
      kubectl apply -f $vcloud_csi_configmap_path

      wget -O $csi_driver_path https://raw.githubusercontent.com/vmware/cloud-director-named-disk-csi-driver/{csi_version}/manifests/csi-driver.yaml
      wget -O $csi_controller_path https://raw.githubusercontent.com/vmware/cloud-director-named-disk-csi-driver/{csi_version}/manifests/csi-controller.yaml
      wget -O $csi_node_path https://raw.githubusercontent.com/vmware/cloud-director-named-disk-csi-driver/{csi_version}/manifests/csi-node.yaml
      kubectl apply -f $csi_driver_path
      kubectl apply -f $csi_controller_path
      kubectl apply -f $csi_node_path
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.csi.install.status successful"

    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.default_storage_class.status in_progress"
      create_default_storage_class={create_default_storage_class}
      if [[ "$create_default_storage_class" = true ]] ; then
        kubectl apply -f /root/default-storage-class.yaml
      fi
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.default_storage_class.status successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.kapp_controller.install in_progress"
      if [[ -z "$full_kapp_controller_version" ]] || [[ "$full_kapp_controller_version" = "null" ]] || [[ "$full_kapp_controller_version" = "false" ]]; then
        sed -i "s/__KAPP_CONTROLLER_VERSION_SED_ME__/$kapp_controller_version/" $kapp_controller_path
        sed -i "s/__FULL_KAPP_CONTROLLER_VERSION_SED_ME__/$kapp_controller_version/" $full_kapp_controller_path
        kubectl apply -f $kapp_controller_path

        # kapp controller takes ~5 minutes to be in ready status
        kapp_loops_try=0
        max_kapp_loops_try=17
        kapp_ready=true
        while [[ "$(kubectl get pods -l=app='kapp-controller' -A -o jsonpath='OPEN_BRACKET.items[*].status.containerStatuses[0].readyCLOSE_BRACKET')" != "true" ]]; do
          if [[ "$kapp_loops_try" -gt  $max_kapp_loops_try"]]; then
            kapp_ready=false
            break
          fi
          sleep 30
          echo "waiting for kapp-controller" >> /var/log/cse/customization/status.log
          ((kapp_loops_try=kapp_loops_try++))
        done
        if [[ "$kapp_ready" = false ]]; then
          full_kapp_controller_version=""
        fi
      fi
      vmtoolsd --cmd "info-set guestinfo.postcustomization.kapp_controller.version $full_kapp_controller_version"
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubectl.kapp_controller.install successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.tanzu_cli.install in_progress"
      # kapp controller is needed to use tanzu-cli
      tanzu_cli_installed=false
      if [[ "$kapp_ready" = true ]] && [[ "metrics_server_version_ready" = true ]]; then
        wget https://github.com/vmware-tanzu/tanzu-framework/releases/download/v0.17.0/tanzu-cli-linux-amd64.tar.gz
        mkdir tanzu && tar -zxvf tanzu-cli-linux-amd64.tar.gz -C tanzu
        sudo install tanzu/v0.17.0/tanzu-core-linux_amd64 /usr/local/bin/tanzu
        tanzu plugin install package

        tanzu package repository add tanzu-core --namespace tkg-system --create-namespace --url projects.registry.VMware.com/tkg/packages/core/repo:$OPEN_BRACKETk8s_versionCLOSE_BRACKET
        tanzu package install metrics-server --namespace tkg-system --create-namespace --package-name metrics-server.tanzu.vmware.com --version
        tanzu_cli_installed=true
      fi
    vmtoolsd --cmd "info-set guestinfo.postcustomization.tanzu_cli.install successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.metrics_server.install in_progress"
      if [[ "$tanzu_cli_installed" = true ]]; then
        tanzu package install metrics-server --namespace tkg-system --create-namespace --package-name metrics-server.tanzu.vmware.com --version $metrics_server_version
        vmtoolsd --cmd "info-set guestinfo.postcustomization.metrics_server.version $metrics_server_version"
      fi
      vmtoolsd --cmd "info-set guestinfo.postcustomization.metrics_server.version $metrics_server_version"
    vmtoolsd --cmd "info-set guestinfo.postcustomization.metrics_server.install successful"


    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubeadm.token.generate.status in_progress"
      kubeadm_join_info=$(kubeadm token create --print-join-command --ttl 0 2> /dev/null)
      vmtoolsd --cmd "info-set guestinfo.postcustomization.kubeadm.token.info $kubeadm_join_info"
    vmtoolsd --cmd "info-set guestinfo.postcustomization.kubeadm.token.generate.status successful"

    echo "$(date) post customization script execution completed" &>> /var/log/cse/customization/status.log
    exit 0
runcmd:
- '[ ! -f /root/kubeadm-defaults.conf ] && cloud-init clean && sudo reboot'
- '[ ! -f /root/vcloud-basic-auth.yaml ] && cloud-init clean && sudo reboot'
- '[ ! -f /root/control_plane.sh ] && cloud-init clean && sudo reboot'
- bash /root/control_plane.sh
timezone: UTC
disable_root: false
preserve_hostname: false
hostname: {vm_host_name}
final_message: "The system is ready after $UPTIME seconds"
